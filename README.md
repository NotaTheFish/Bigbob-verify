<<<<<<< HEAD
\# Bigbob Verify Bot Architecture



\## 1. Project Goals

\- Roblox account ownership verification for Telegram users.

\- In-bot UI: \*\*Play\*\*, \*\*Shop\*\*, \*\*Profile\*\*, \*\*Support\*\*, \*\*Admin menu\*\*.

\- Durable, restart-resistant storage and synchronisation of all in-game data via the bot.

\- Comprehensive admin tooling with logging, role segregation, and secure entry.



\## 2. Security Principles \& Mandatory Changes

\- \*\*No credentials ever collected\*\*: never ask for Roblox login/password or `.ROBLOSECURITY`; rely solely on in-game verification codes.

\- \*\*Input validation\*\*: constrain and validate all user input (nicknames, promo codes, item IDs, currency amounts) for length and allowed characters.

\- \*\*Role-based access control\*\*: admin access requires invite tokens. Login flow demands a one-time admin token plus approval from the Main Admin. Tokens are one-use and time-bound.

\- \*\*Signed traffic\*\*: every Roblox ↔ web server request uses HMAC signatures and includes an idempotency key.

\- \*\*Logging \& auditing\*\*: capture admin actions with user ID, IP (if available), timestamps, and operation details. Audit logs are visible to the Main Admin.

\- \*\*Minimal personal data\*\*: store only `telegram\_user\_id`, `roblox\_player\_id`, metadata, and balances. Define TTL for one-time codes and purge inactive profiles periodically.

\- \*\*Referral antifraud\*\*: cap referral rewards per day, validate Roblox account age, and require minimum invited-player activity (verification + ≥10 minutes gameplay) before issuing rewards.



\## 3. Verification Flow

1\. User runs `/start` → selects \*\*Verification\*\* → enters Roblox nickname.

2\. Bot generates an alphanumeric `verification\_code` (6–8 chars, e.g. `BB-7f3K2`), stores it in `verifications` with TTL 10 minutes and status `pending`.

3\. Bot instructs user to place the code into their Roblox profile description/status.

4\. Roblox game server posts `POST /api/verify-callback` with `{ playerId, code, ts }` plus HMAC header. Web server validates signature and marks the verification `used`.

5\. Alternative polling: if direct POST is unavailable, bot queries the Roblox public API by nickname and searches the description for the normalized code substring (remove whitespace/punctuation, compare exact substring).

6\. Upon success, link `telegram\_user\_id ↔ roblox\_player\_id` in `users` table.



\## 4. Data Synchronisation \& Reliability

\- \*\*Pipeline\*\*: Roblox Game Server → Webhook API → Persistent Queue (Redis/RabbitMQ/BullMQ) → Workers → Primary DB (Postgres/Supabase).

\- \*\*Event handling\*\*: each game event (progress save, purchase, achievement) arrives with HMAC + `event\_id`. Web server validates and enqueues. Workers process events transactionally with optimistic locking.

\- \*\*Two-phase critical ops\*\*: purchases create `purchase\_request` entries (`pending`). Game server confirms via signed callback before completion.

\- \*\*Resilience\*\*: daily DB backups, WAL archiving/PITR, queue persistence, monitoring for worker/queue failures.



\## 5. Core Database Tables

| Table | Key Fields |

|-------|------------|

| `users` | `id`, `telegram\_id`, `roblox\_id`, `username`, `verified\_at`, `invited\_by`, `created\_at`, `last\_active` |

| `verifications` | `id`, `telegram\_id`, `roblox\_nick`, `code`, `status`, `expires\_at`, `created\_at` |

| `balances` | `user\_id`, `nuts\_balance`, `reserved\_balance` |

| `referrals` | `id`, `referrer\_id`, `referred\_id`, `reward\_amount`, `status`, `created\_at` |

| `promo\_codes` | `code`, `type` (`nuts`/`privilege`), `value`, `activations\_left`, `expires\_at`, `creator\_admin\_id` |

| `items` | `item\_id`, `name`, `description`, `copies\_total`, `copies\_sold`, `creator\_admin` |

| `purchase\_requests` | `request\_id`, `user\_id`, `item\_id`, `status`, `idempotency\_key`, `created\_at`, `completed\_at` |

| `admins` | `admin\_id`, `telegram\_id`, `role` (`main`/`manager`/`support`), `granted\_by`, `granted\_at`, `revoked\_at` |

| `admin\_actions\_log` | `action\_id`, `admin\_id`, `action\_type`, `target`, `details`, `ts` |

| `events\_queue` | persistent storage of unprocessed events for monitoring/replays |



\## 6. Admin Flow \& Security

\- Login command: `/admin\_login <token>`.

\- Tokens are generated by Main Admin, one-time, TTL-bound. Main Admin bypasses approval; other roles trigger a notification to Main Admin for approval/rejection.

\- Define ACL per role (`main\_admin`, `manager`, `support`).

\- Critical actions (item deletion, bans) require confirmation prompts (e.g. type `YES`) or re-auth.

\- Avoid static passwords (e.g. `BigBob-Admin-2025`). Use initial onboarding secret followed by per-user tokens.

\- Logs accessible via `/admin\_logs` and `/admins` commands to Main Admin only, with filters/export (CSV) and retention policies.



\## 7. Shop \& Purchases

\- Bot never performs purchases with user credentials.

\- Flow: user selects item → bot creates `purchase\_request` (`pending`) and returns receipt with `idempotency\_key`.

\- Game server processes request, then calls `confirm\_purchase(request\_id, signature)`. Worker validates, marks `completed`, updates `items.copies\_sold`, assigns privileges.

\- Transactions must check availability (`copies\_left`, `user\_has\_item`).

\- Refunds: pending requests expire after TTL; reserved balances revert automatically.



\## 8. Referral System Safeguards

\- Reward only after invitee verification and minimum activity (e.g. ≥10 minutes in-game or level threshold).

\- Cap rewards per referrer per day.

\- Maintain logs for fraud review; suspicious cases flagged for manual admin audit.



\## 9. UX \& Additional Requirements

\- Persistent \*\*Back\*\* buttons and form timeouts.

\- Dialogues are step-by-step, with conversational state expiring after 15–30 minutes (profile view excluded).

\- Profile view includes summary and generated referral link (UTM-like containing user ID).

\- Promo code creation offers preview and bulk import tooling.

\- Server indexing maintains ordered identifiers; deleting a server reindexes automatically.



\## 10. Operations: Deployment, Secrets, Monitoring

\- Hosting recommendation: Fly.io or Railway/Supabase with persistent queues and backups.

\- Environment variables: `DB\_URL`, `HMAC\_SECRET`, `ADMIN\_INITIAL\_TOKEN`, `REDIS\_URL`, `SENTRY\_DSN`, etc.; rotate secrets every 90 days.

\- Monitoring: integrate Sentry, Prometheus (or equivalent) with alerts for worker failures, queue latency, or failed HMAC validations.

\- Backups: daily DB snapshots with off-site storage, 30-day retention.



\## 11. Testing \& Rollout Strategy

\- Unit tests for financial transactions (purchases, balance adjustments).

\- Integration tests simulating game server interactions, verifying HMAC checks and idempotency handling.

\- Canary release: start with admins only, then 5% of users, then full rollout.



\## 12. Initial Implementation Checklist

1\. Define DB schema and migrations.

2\. Implement verification flow (code issuance, callback or API polling).

3\. Set up signed webhooks and durable queue.

4\. Build `purchase\_request` pipeline with idempotency and transactional guarantees.

5\. Create admin authentication via one-time tokens and Main Admin approval flow.

6\. Enforce referral limits and antifraud rules.

7\. Implement logging/audit pipeline and backup routines.

=======
# Bigbob-verify
>>>>>>> 66b897a83f61b42d1d51c1bcd674a9332129d31e
